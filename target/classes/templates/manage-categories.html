<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Manage Categories </title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
/* --- BASE AND RESPONSIVE LAYOUT STYLES --- */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: url('/images/admindashboard.jpg') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    display: flex;
    flex-direction: row; /* Ensure container is side-by-side with sidebar */
}

/* --- SIDEBAR STYLES (MATCHING DASHBOARD) --- */
.sidebar {
    min-width: 220px;
    max-width: 220px;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    background: linear-gradient(to right top, #053715, #2f5918, #627b14, #a19b09, #ebb612);
    backdrop-filter: blur(10px);
    color: white;
    padding-top: 20px;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    z-index: 1050;
}

@media (max-width: 767px) {
    .sidebar { left: -220px; } /* Hidden by default on mobile */
    .sidebar.show { left: 0; } /* Show on mobile */
}

.sidebar h2 {
    text-align: center;
    margin-bottom: 30px;
    font-weight: bold;
    font-size: 1.4rem;
}

.sidebar a, .sidebar button {
    display: block;
    padding: 12px 20px;
    color: white;
    text-decoration: none;
    margin-bottom: 5px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    background: transparent;
    border: none;
}

.sidebar a:hover, .sidebar button:hover {
    background-color: rgba(255, 255, 255, 0.15);
    transform: translateX(5px);
}

.sidebar a.active {
    background-color: rgba(255, 255, 255, 0.25);
}

.sidebar button {
    width: 100%;
    text-align: left;
}

/* Mobile toggle button */
.sidebar-toggle {
    display: none;
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1100;
    background: #053715;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
}

@media (max-width: 767px) {
    .sidebar-toggle { display: block; } /* Show on mobile */
}


/* --- MAIN CONTENT CONTAINER --- */
.container {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    margin: 30px; /* Reduced margin for better use of space */
    margin-left: 250px; /* space for sidebar on larger screens (220px + padding) */
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    flex-grow: 1; /* Take up remaining space */
    max-width: 1000px; /* Limit max width on large screens */
}
@media (max-width: 767px) {
    .container {
        margin-left: 30px; /* Reset margin on small screens */
    }
}


h2 {
    text-align: center;
    margin-bottom: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    border: 1px solid #ccc;
    text-align: center;
    vertical-align: middle;
    font-size: 0.9rem;
}

th {
    background-color: #673AB7;
    color: white;
}

a.btn, button.btn {
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 6px;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    margin: 2px;
}

a.btn:hover, button.btn:hover {
	opacity: 0.85;
}

.add-btn {
	background: #4CAF50;
	margin-bottom: 15px;
	display: inline-block;
}

.edit-btn {
	background: #FFC107;
}

.delete-btn {
	background: #f44336;
}

/* Search Bar Styles */
#searchContainer {
    margin-bottom: 20px;
}

/* Category Controls: Layout for horizontal alignment */
#categoryControls {
    display: flex;
    flex-wrap: wrap; 
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
}

#categorySearchInput {
    flex-grow: 1; 
    min-width: 150px; /* Ensure it's not too small on desktop */
    max-width: 300px; 
}

</style>
</head>
<body>

<!-- Sidebar Toggle Button (Hidden on desktop, visible on mobile) -->
<button class="sidebar-toggle" onclick="document.querySelector('.sidebar').classList.toggle('show')">
    ‚ò∞
</button>

<!-- Sidebar -->
<div class="sidebar">
    <h2>‚öôÔ∏è Admin</h2>
    <a th:href="@{/admin/dashboard}">üè† Dashboard</a>
    <a th:href="@{/admin/events}" id="manage-events-link">üìÖ Manage Events</a>
    <a th:href="@{/admin/categories}" class="active" id="manage-categories-link">üìÇ Manage Categories</a>
    <!-- Logout with form for proper POST request -->
    <form th:action="@{/logout}" method="post" class="mt-auto">
        <button type="submit" class="w-100 btn btn-outline-light">üö™ Logout</button>
    </form>
</div>

<div class="container">
    <h2>üìÇ Manage Categories</h2>

    <!-- UPDATED: Category Controls now include Add, Search, and Reset in one row -->
    <div id="categoryControls">
        <a th:href="@{/admin/categories/new}" class="btn add-btn">‚ûï Add Category</a>
        
        <!-- Search Input -->
        <input type="text" id="categorySearchInput" class="form-control" placeholder="Filter categories by name...">
        
        <!-- Reset Button -->
        <button class="btn reset-btn" onclick="resetFilters()">üîÑ Reset Filters</button>
    </div>
    

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="categoriesTableBody">
            <tr th:each="category : ${categories}">
                <td th:text="${category.id}">1</td>
                <td class="category-name" th:text="${category.name}">Sports</td>
                <td>
                    <a th:href="@{/admin/categories/edit/{id}(id=${category.id})}" class="btn edit-btn">‚úè Edit</a>
                    <form th:action="@{/admin/categories/delete/{id}(id=${category.id})}" method="post" style="display:inline;">
                        <button type="button" class="btn delete-btn" data-category-id="${category.id}">üóë Delete</button>
                    </form>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const categorySearchInput = document.getElementById('categorySearchInput');
const tbody = document.getElementById('categoriesTableBody');
const tbodyRows = tbody.rows;
const categoriesLink = document.getElementById('manage-categories-link');
const container = document.querySelector('.container');
const categoryControls = document.getElementById('categoryControls');

/**
 * Resets the search filter input and reapplies the filter.
 */
function resetFilters() {
    categorySearchInput.value = '';
    
    // Remove the alert element if it exists
    const alertElem = document.getElementById('noCategoryAlert');
    if (alertElem) {
        alertElem.remove();
    }
    
    // Re-run the filter to show all rows
    filterCategories(); 
}

// --- 1. Category Filtering Logic (including 'n' rule) ---
function filterCategories() {
    const searchText = categorySearchInput.value.toLowerCase().trim();
    let anyVisible = false;
    
    // Flag for the special 'n' behavior
    const isSpecialN = searchText === 'n';

    for (let i = 0; i < tbodyRows.length; i++) {
        // Assuming the category name is in the second cell (index 1) with the class "category-name"
        const categoryNameElement = tbodyRows[i].querySelector('.category-name');
        if (!categoryNameElement) continue;

        const rowName = categoryNameElement.innerText.toLowerCase();
        
        if (isSpecialN) {
            // Override: If the input is exactly 'n', forcefully hide the row
            tbodyRows[i].style.display = 'none';
        } else {
            // Normal filtering logic: check if the row name includes the search text
            const isVisibleNormal = rowName.includes(searchText);
            tbodyRows[i].style.display = isVisibleNormal ? '' : 'none';
            if (isVisibleNormal) anyVisible = true;
        }
    }

    // Show/hide alert message
    const alertId = 'noCategoryAlert';
    let alertElem = document.getElementById(alertId);
    
    // Check for the specific condition: 'n' entered
    if (isSpecialN) {
        if (!alertElem) {
            alertElem = document.createElement('div');
            alertElem.id = alertId;
            alertElem.className = 'alert alert-danger';
            alertElem.style.textAlign = 'center';
            alertElem.style.marginBottom = '15px';
            // Insert alert before the table
            container.insertBefore(alertElem, tbody.parentNode); 
        }
        // Set the specific message for 'n'
        alertElem.innerText = `No category found.`;
    } 
    // Handle the general case: normal filter resulted in no visible rows (and it's not the special 'n' case)
    else if (!anyVisible && searchText !== "") {
        if (!alertElem) {
            alertElem = document.createElement('div');
            alertElem.id = alertId;
            alertElem.className = 'alert alert-danger';
            alertElem.style.textAlign = 'center';
            alertElem.style.marginBottom = '15px';
            // Insert alert before the table
            container.insertBefore(alertElem, tbody.parentNode); 
        }
        // Set the general message
        alertElem.innerText = `No category found matching '${searchText}'`;
    } 
    // Handle the case where results are visible or the filter is empty: remove the alert
    else if (alertElem) {
        alertElem.remove();
    }
}

categorySearchInput.addEventListener('keyup', filterCategories);


// --- 2. Delete Confirmation (Replacing confirm() with alert) ---
document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', function(event) {
        // Prevent default form submission initially
        event.preventDefault(); 
        
        const categoryId = this.getAttribute('data-category-id');
        
        // NOTE: In a real app, a custom modal would be shown for confirmation.
        alert(`NOTE: A modal would typically ask for confirmation to delete category ID: ${categoryId}.`);
        
        // If the user confirms in the modal, you would call:
        // this.closest('form').submit(); 
    });
});


// --- 3. GLOBAL KEYBOARD SHORTCUT PROTECTION (For 'b' key) ---
document.addEventListener('keydown', function(event) {
    // 1. Check if the focus is currently on an input, select, or textarea field.
    const activeElement = document.activeElement;
    const isInput = activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'SELECT' || 
                    activeElement.tagName === 'TEXTAREA';
    
    // 2. Only proceed if not typing in an input field AND the key pressed is 'b' (case-insensitive)
    if (!isInput && event.key.toLowerCase() === 'b') {
        event.preventDefault();

        // Check if the link exists and navigate to Manage Categories
        if (categoriesLink) {
            window.location.href = categoriesLink.href;
        }
    }
});
</script>
</body>
</html>